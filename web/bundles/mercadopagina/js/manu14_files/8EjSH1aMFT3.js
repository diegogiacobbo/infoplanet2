/*1364911499,173220389*/

if (self.CavalryLogger) { CavalryLogger.start_js(["71aj9"]); }

__d("InteractionLogger",["Arbiter","Banzai","copyProperties","event-extensions"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('Banzai'),i=b('copyProperties');b('event-extensions');function j(k,l){l=l||{};this.profiler={};this.log={};this.lastInteraction=Date.now();this.interactionTime=0;this.eventSequence=[];this.projectName=k;if(l.trackInteractionTime)Event.listen(document.body,'mousemove',this._pingActive.bind(this));if(l.submitOnLeave||l.submitOnLeave===undefined)g.subscribe('onload/exit',function(){this.submit();}.bind(this));}i(j,{IDLE_LIMIT:20000});i(j.prototype,{set:function(k,l){this.log[k]=l;},tap:function(k){this.eventSequence.push(k);},bump:function(k,l){if(l===undefined)l=1;this.log[k]=(this.log[k]||0)+l;},bumpTap:function(k,l){this.tap(k);this.bump(k,l);},startRun:function(k){if(!this.profiler[k])this.profiler[k]={average:0,count:0};this.profiler[k].start=+new Date();},endRun:function(k){if(!this.profiler[k]||!this.profiler[k].start)return;this._recordRun(k,new Date()-this.profiler[k].start);this.profiler[k].start=null;},getLog:function(){this._updateLog();return this.log;},submit:function(){this._updateLog();h.post(this.projectName,this.log);},_pingActive:function(){var k=Date.now(),l=k-this.lastInteraction;if(l<(j.IDLE_LIMIT))this.interactionTime+=l;this.lastInteraction=k;},_updateLog:function(){for(var k in this.profiler){this.log[k+'-count']=this.profiler[k].count;this.log[k+'-average']=this.profiler[k].average;}if(this.interactionTime)this.log['interaction-time']=this.interactionTime;if(this.eventSequence.length)this.log['event-sequence']=this.eventSequence;},_recordRun:function(k,l){var m=this.profiler[k];m.average=(m.average*m.count+l)/(m.count+1);m.count++;}});e.exports=j;});
__d("TimelineMapPlace",["arrayContains","copyProperties"],function(a,b,c,d,e,f){var g=b('arrayContains'),h=b('copyProperties');function i(j){this.stories=[];this.creation=false;this.name=null;j.latitude||(j.latitude=0);j.longitude||(j.longitude=0);h(this,j);if(this.region)this.region=this.region+':'+this.country;this.visibleStories=this.stories;}h(i.prototype,{setFilters:function(j,k){var l=[];for(var m=0;m<this.stories.length;m++){var n=this.stories[m].passesTimeframe(j)&&(!k||g(this.stories[m].categories,k));if(n)l.push(this.stories[m]);}this.visibleStories=l;},getStories:function(j,k){if(j===undefined)j=true;var l=j?this.visibleStories:this.stories;if(!k){return l;}else{var m=[];for(var n=0;n<l.length;n++){var o=l[n];if(k(o))m.push(o);}return m;}},count:function(j,k){var l=this.getStories(j,k).length;if(this.creation)l++;return l;}});h(i,{Filters:{MLE:function(j){return j&&!j.isEnt;},ALL:null}});e.exports=i;});
__d("TimelineMapStory",["copyProperties"],function(a,b,c,d,e,f){var g=b('copyProperties');function h(i){g(this,i);}g(h.prototype,{passesTimeframe:function(i){return (!i||(!i.start||this.timestamp!==null&&i.start<=this.timestamp)&&(!i.end||this.timestamp!==null&&i.end>this.timestamp));}});e.exports=h;});
__d("randomShuffle",["randomInt"],function(a,b,c,d,e,f){var g=b('randomInt');function h(i){for(var j=i.length-1;j>0;j--){var k=g.call(this,j+1);if(k!=j){var l=i[k];i[k]=i[j];i[j]=l;}}return i;}e.exports=h;});
__d("TimelineMapController",["AggregatedMap","AggregatedMapCalloutOrientation","AggregatedMapPin","AggregatedMapRedPinSprite","Arbiter","AsyncRequest","BingMapCoordinate","CSS","DOM","MapRects","Rect","Style","TimelineMapPlace","TimelineMapStory","Vector","$","copyProperties","isEmpty","mod","randomShuffle"],function(a,b,c,d,e,f){var g=b('AggregatedMap'),h=b('AggregatedMapCalloutOrientation'),i=b('AggregatedMapPin'),j=b('AggregatedMapRedPinSprite'),k=b('Arbiter'),l=b('AsyncRequest'),m=b('BingMapCoordinate'),n=b('CSS'),o=b('DOM'),p=b('MapRects'),q=b('Rect'),r=b('Style'),s=b('TimelineMapPlace'),t=b('TimelineMapStory'),u=b('Vector'),v=b('$'),w=b('copyProperties'),x=b('isEmpty'),y=b('mod'),z=b('randomShuffle'),aa=198,ba=132,ca=108;function da(ea,fa,ga,ha,ia){this.profileID=null;this.viewasID=null;this.places={};this.visiblePins=null;this.stories={};this.hiddenStories={};this.placesByTime=[];this.category=null;this.timeframe=null;this.pending=null;this.waitingOnConfirmation=false;this.highlightedPin=null;this.arbiterListeners=[];this.calloutBeingFetched=null;this.initialized=false;this._lastResizeCalloutAnchor=null;this._lastResizeCalloutStoryHeight=null;this._lastResizeCalloutStory=null;this._scrollableCalloutController=null;this.inCreation=false;this.lastTypeaheadEvent=null;this.initialPosition=null;this.initialPlace=null;this.initialStory=null;this.hh=0;this.ww=0;this.smartPan=null;this.requestID=0;this.asyncRequests={};this.intervals=[];this.groups=[];this.pagerIndex=null;this.categoryCountUnique={};if(ea)this._init(ea,fa,ga,ha,ia);}w(da.prototype,{HOVER_FETCH_DELAY:100,HOVER_DISMISS_DELAY:300,MAP_BOTTOM_PADDING:40,MIN_MAP_HEIGHT:532,MIN_CALLOUT_STORY_HEIGHT:200,MAX_CALLOUT_HEIGHT:458,RESIZE_CHECK_INTERVAL:50,HOVERCARD_WIDTH:279,HOVERCARD_HEIGHT:251,HOVERCARD_CLOSED:undefined,HOVERCARD_WAITING_TO_FETCH:1,HOVERCARD_BEING_FETCHED:2,HOVERCARD_OPEN:3,HOVERCARD_WAITING_TO_DISMISS:4,TIMELINE_MAP_HOVERCARD_PLACE:'Place',TIMELINE_MAP_HOVERCARD_CITY:'City',TIMELINE_MAP_HOVERCARD_REGION:'Region',TIMELINE_MAP_HOVERCARD_COUNTRY:'Country',HOVERCARD_CITY_REGION_HEURISTIC:3,setCategory:function(ea){this.logger&&this.logger.startRun('set-category');this.map.hideCallout();this.category=ea;this._filter();},setTimeframe:function(ea,fa){this.logger&&this.logger.startRun('set-timeframe');this.map.hideCallout();this.timeframe=fa;this._filter();this._inform(da.Events.timeframeChange,null,k.BEHAVIOR_STATE);},setCategoryCountUnique:function(ea){this.categoryCountUnique=ea;},getCategories:function(){var ea={},fa,ga;for(var ha in this.places){var ia=this.places[ha],ja={},ka=0;for(var la=0;la<ia.stories.length;la++){ga=ia.stories[la];if(ga.passesTimeframe(this.timeframe)){ka++;if(ga.categories)for(var ma=0;ma<ga.categories.length;ma++){fa=ga.categories[ma];if(this.categoryCountUnique[fa]&&ja[fa])continue;if(!ea[fa])ea[fa]={count:0,name:fa};if(!ja[fa])ja[fa]=1;ea[fa].count++;}}}}return ea;},zoomToVisible:function(){this.map.zoomTo(this.visiblePins);},cleanupCreationCallout:function(ea){this.map.hideCallout(ea);this._cleanUpHiglightedPin();},cancelCreation:function(ea){if(!this.inCreation)return;this.inCreation=false;this.cleanupCreationCallout();k.inform('TimelineMapTour/resumeTour');},creationFinished:function(ea,fa){var ga=fa.place,ha=fa.story,ia=fa.showCallout;this.inCreation=false;this.waitingOnConfirmation=false;this.cleanupCreationCallout();this.addStories(null,{stories:[ha],places:[ga]});if(ia)this.showCallout(null,{place_id:ga.id,story_id:ha.id});k.inform('TimelineMapTour/resumeTour');},page:function(ea,fa){var ga=this.map.getGroups();if(!ga)return;var ha=[],ia=true,ja=0;for(var ka=0;ka<ga.length;ka++){var la=ga[ka];if(la.hasMarker()){var ma=la.getCenter(),na=new q(0,this.ww,this.hh,0);if(p.containsPoint(na,ma)){ha.push(la);if(la===this.groups[ja]){ja++;}else if(ia)ia=false;}}}ia=ia&&ja===this.groups.length;if(!ia){this.groups=ha;this.sortedGroups=ha.concat([]).sort(function(pa,qa){return pa.getCenter().x-qa.getCenter().x;});if(fa>0){this.pagerIndex=0;}else this.pagerIndex=-1;}else this.pagerIndex+=(fa>0)?1:-1;this.pagerIndex=y(this.pagerIndex,this.sortedGroups.length);var oa=this.sortedGroups[this.pagerIndex];if(oa.pins.length>1){this._openCallout(oa,this.map.throbber(325),this.map.leftRightNoPanningStrategy());oa.hoverPermanent=true;oa.hoverState=this.HOVERCARD_WAITING_TO_FETCH;this._fetchHovercard(oa);}else this._mapHandler_pinClick(null,oa.pins[0]);},hovercard:function(ea,fa){var ga=this._getAsyncContext(fa.requestID);if(ga.deleted||ga.hoverState!==this.HOVERCARD_BEING_FETCHED)return;ga.hoverState=this.HOVERCARD_OPEN;var ha=o.create('div');ha.onmouseover=function(){if(!this.map||!this.map.getCallout().getAnchor())return null;this._mapHandler_bubbleMouseover(null,this.map.getCallout().getAnchor());}.bind(this);ha.onmouseout=function(){if(!this.map||!this.map.getCallout().getAnchor())return null;this._mapHandler_bubbleMouseout(null,this.map.getCallout().getAnchor());}.bind(this);n.setClass(ha,'fbTimelineMapHovercard');o.setContent(ha,fa.content);if(ga===this.map.getCallout().getAnchor()){this.map.getCallout().setContent(ha);}else this._openCallout(ga,ha,this.map.leftRightNoPanningStrategy());this.map.getCallout().recalculateArrowYOffset(true);this.logger&&this.logger.endRun('load-hovercard');},callout:function(ea,fa){var ga=this._getAsyncContext(fa.requestID);if(this.map.getCallout().getAnchor()!==ga)return;this._openCallout(ga,fa.content);this.logger&&this.logger.endRun('load-callout');},addPending:function(ea,fa){var ga=fa.count;this.pending=this.pending||0;this.pending+=ga;this._checkReady();},hideCallout:function(ea,fa){fa=fa||{};fa._instanceid=this.instanceID;k.inform('AggregatedMap/hideCallout',fa);},addStories:function(ea,fa){var ga=fa.stories,ha=fa.places;if(fa.count)this.pending=(this.pending||0)-fa.count;var ia,ja,ka,la;for(la=0;la<ha.length;la++){ja=new s(ha[la]);if(!this.places[ja.id]){this.places[ja.id]=ja;this.placesByTime.push(ja);}ja.mostRecentTimestamp=0;}for(la=0;la<ga.length;la++){ka=new t(ga[la]);this.stories[ka.id]=ka;ia=ka.placeID;ja=this.places[ia];ja.stories.push(ka);ja.mostRecentTimestamp=Math.max(ja.mostRecentTimestamp,ka.timestamp);}if(fa.count===undefined){this._refresh();}else this._checkReady();},updateStory:function(ea,fa){var ga=fa.place,ha=fa.story,ia=this.stories[ha.id];if(ia.placeID!=ga.id){var ja={};ja[ia.id]=true;this._removeStories(ia.placeID,ja);this.addStories(null,{stories:[ha],places:[ga]});}this._showCallout(this.places[ga.id].pin,ga.id,ha.id);},deleteStory:function(ea,fa){var ga=this.map.getCallout().getAnchor(),ha=this.stories[fa];if(!ha)return;var ia={};ia[ha.id]=true;this.map.hideCallout();var ja=this._removeStories(ha.placeID,ia);ja.stories_removed&&this._refresh();!ja.place_removed&&this._showCallout(ga,ga.place.id);},hideStory:function(ea,fa){var ga=this.map.getCallout().getAnchor(),ha=this.stories[fa.story_id];if(!ga)return;if(ga.getType()!=='AggregatedMapPin')return;if(!ha||ha.placeID!=ga.place.id)return;var ia=v(fa.story_domid);n.hide(ia);var ja=o.insertAfter(ia,fa.undo_html)[0];this.hiddenStories[ha.id]={story_domid:ia.id,undo_domid:ja.id};},undoHideStory:function(ea,fa){var ga=this.stories[fa],ha=this.hiddenStories[ga.id];o.remove(ha.undo_domid);n.show(ha.story_domid);delete this.hiddenStories[ga.id];},showCallout:function(ea,fa){var ga=this.places[fa.place_id].pin;this._showCallout(ga,fa.place_id,fa.story_id);},zoomIntoOne:function(ea,fa){var ga=this.places[fa.place_id];this._zoomToPlace(ga);},zoomToArea:function(ea,fa){var ga=fa.type,ha=fa.key,ia=[];for(var ja in this.places){var ka=this.places[ja],la=ka.pin;if((ka.city===ha&&ga===this.TIMELINE_MAP_HOVERCARD_CITY)||(ka.region===ha&&ga===this.TIMELINE_MAP_HOVERCARD_REGION)||(ka.country===ha&&ga===this.TIMELINE_MAP_HOVERCARD_COUNTRY))ia.push(la);}this.map.zoomInto(ia);},creationFlow:function(ea,fa){var ga=fa.place,ha={latitude:ga.latitude,longitude:ga.longitude};this.waitingOnConfirmation=false;this._highlightPlace(ga.id,ha);this._openCallout(this.highlightedPin,fa.content,this.smartPan);this.inCreation=true;},highlightMapPlace:function(ea,fa){if(fa.dismiss&&this.waitingOnConfirmation)return;if(fa.showThrobber){this._openCallout(this.highlightedPin,this.map.throbber(),this.smartPan);return;}this.map.hideCallout();if(fa.dismiss){this._cleanUpHiglightedPin();}else if(fa.selected){this.waitingOnConfirmation=true;}else if(fa.center)this._highlightPlace(fa.placeID,fa.center);this.map.setView(fa);},registerScrollableCallout:function(ea,fa){this._scrollableCalloutController=fa;},_init:function(ea,fa,ga,ha,ia,ja){this.profileID=ea;this.viewasID=fa.viewas;this.mapContainer=ga;this.canvas=o.find(this.mapContainer,'.fbAggregatedMapContainer');this.logger=ia;this.instanceID=ha;this._dynamicSize=fa.dynamicSize;if(fa.center)this.initialPosition={latitude:fa.center.lat,longitude:fa.center.long};this.initialPlace=fa.highlightedPlace;this.initialStory=fa.highlightedStory;this.enableHovercards=fa.enableHovercards;this.calloutDiv=ja&&v(ja);this.border=v('fbTimelineMapBorder');this._subscribe('onload/exit',this._onBeforeLeave.bind(this));this._subscribe('AggregatedMap/ready',this._onInit.bind(this));this._subscribe('AggregatedMap/calloutHidden',this.cancelCreation.bind(this));this._subscribe('AggregatedMap/calloutHidden',k.inform.shield(null,'reflow'));this._subscribe('TimelineMapStickyHeaderComposer/typeaheadFocus',this._handleTypeahead.bind(this,'focus'));this._subscribe('TimelineMapStickyHeaderComposer/typeaheadBlur',this._handleTypeahead.bind(this,'blur'));this._subscribe('TimelineMapStickyHeaderComposer/typeaheadSelect',this._handleTypeahead.bind(this,'select'));},_onInit:function(ea,fa){this.map=fa;if(this._dynamicSize){this._resizeMap();this.intervals=[setInterval(this._resizeMap.bind(this),this.RESIZE_CHECK_INTERVAL),setInterval(this._resizeCallout.bind(this),this.RESIZE_CHECK_INTERVAL)];}else{this.hh=this.map.hh;this.ww=this.map.ww;}this.initialized=true;for(var ga in da.Listeners)this._subscribe('TimelineMap/'+ga,this[ga].bind(this));for(var ha in g.Events){var ia=this['_mapHandler_'+ha];if(ia){ia=ia.bind(this);this._subscribe('AggregatedMap/'+ha,ia);}}this.smartPan=this.map.smartPanningStrategy();},_getAsyncContext:function(ea){var fa=this.asyncRequests[ea];delete this.asyncRequests[ea];return fa;},_storeAsyncContext:function(ea){var fa=this.requestID++;this.asyncRequests[fa]=ea;return fa;},_inform:function(ea,fa,ga){fa=fa||{};fa._instanceid=this.instanceID;k.inform('TimelineMap/'+ea,fa,ga);},_cleanUpHiglightedPin:function(){if(this.highlightedPin){if(this.highlightedPin.isPreview){this.map.removePin(this.highlightedPin);}else{this.highlightedPin.setSprite(this._getPlaceSprite(this.highlightedPin.place));this.map.redraw();}this.highlightedPin=null;n.removeClass(this.canvas,'fbTimelineMapDimPinMode');}},_handleTypeahead:function(ea){if(!this.inCreation&&ea=='blur'&&this.lastTypeaheadEvent=='focus')k.inform('TimelineMapTour/resumeTour');this.lastTypeaheadEvent=ea;},_checkReady:function(){if(this.pending!==0)return;this._refresh();if(this.logger){window._cstart&&this.logger.set('flushTTI',Date.now()-window._cstart);for(var ea in this.places){var fa=this.places[ea];this.logger.bump('places');this.logger.bump('stories',fa.count());}this.logger.set('profileID',this.profileID);}if(window.CavalryLogger)window.CavalryLogger.getInstance().measurePageLoad(true);var ga=this.initialPlace,ha=this.initialStory;if(ga){this.map.zoomTo(this.visiblePins,false);this.map.setInitialView();var ia=this.places[ga].pin;if(ia){var ja=new u(aa,ba);ja=ja.sub(new u(this.ww/2,this.hh/2));this.map.zoomIntoOne(ia,ja);var ka=o.find(this.calloutDiv,'.fbTimelineMapCallout');o.remove(this.calloutDiv);this._openCallout(ia,ka);this.map.getCallout().setArrowYOffset(ca);this.map.updateCallouts();}}else if(this.initialPosition){this.map.setView({center:this.initialPosition});}else{this.map.zoomTo(this.visiblePins,false);this.map.setInitialView();}n.addClass(this.border,'fbTimelineMapContainerLoaded');},_refresh:function(){this.placesByTime=this.placesByTime.sort(function(ea,fa){return ea.mostRecentTimestamp-fa.mostRecentTimestamp;});this._filter();this._inform(da.Events.timeframeChange,null,k.BEHAVIOR_STATE);},_resizeMap:function(){var ea=u.getViewportDimensions().y,fa=u.getElementPosition(this.border).y,ga=u.getElementDimensions(this.border).y,ha=ea-(fa+ga),ia=this.hh+ha-this.MAP_BOTTOM_PADDING;ia=Math.max(this.MIN_MAP_HEIGHT,Math.min(ia,ea));if(Math.abs(this.hh-ia)>1){r.set(this.mapContainer,'height',ia+'px');this.hh=ia;this.ww=this.map.ww;this.map.resizingTo(this.ww,this.hh);this._resizeMap();}},_resizeCallout:function(){var ea=this.map.getCallout().getContent(),fa=o.scry(ea,'.fbTimelineMapScrollableStory');for(var ga=fa.length-1;ga>=0;ga--)if(!n.hasClass(fa[ga],'hidden_elem')){var ha=fa[ga],ia=o.find(ha,'.fbTimelineMapCalloutStory');break;}if(!(ea&&ia&&ha))return;var ja=u.getElementDimensions(ia).y;if(this.map.getCallout().getAnchor()===this._lastResizeCalloutAnchor&&ja===this._lastResizeCalloutStoryHeight&&ia===this._lastResizeCalloutStory)return;var ka=o.find(ea,'.fbTimelineMapCalloutHeader'),la=u.getElementDimensions(ka).y,ma=u.getElementPosition(ha).y,na=u.getElementPosition(this.mapContainer).y,oa=this.hh-this.map.CALLOUT_MARGIN,pa=Math.max(this.MIN_CALLOUT_STORY_HEIGHT,Math.min((na+oa)-ma,oa-la)),qa=Math.min(ja,pa,this.MAX_CALLOUT_HEIGHT);r.set(ha,'height',qa+'px');this._lastResizeCalloutAnchor=this.map.getCallout().getAnchor();this._lastResizeCalloutStoryHeight=ja;this._lastResizeCalloutStory=ia;if(this._scrollableCalloutController)this._scrollableCalloutController.adjustGripper();this.map.getCallout()._updateDimensions();this.map.getCallout().recalculateArrowYOffset();},_filter:function(){var ea=[];for(var fa in this.places){var ga=this.places[fa];ga.setFilters(this.timeframe,this.category);if(ga.count()>0){var ha=this._getPlaceSprite(ga),ia=i.create(ga,ha,ga.name);ga.pin=ia;ia.place=ga;ea.push(ia);}}this.visiblePins=ea;if(this.highlightedPin)this.visiblePins.push(this.highlightedPin);this.map.setPins(ea);},_getPlaceSprite:function(ea){var fa=ea.getStories(),ga=fa.length,ha;if(ga>=100){ha=j.largeBlank(ga);}else if(ga>10){ha=j.mediumBlank(ga);}else if(ga>1){ha=j.smallBlank(ga);}else if(fa[0]&&fa[0].pin){ha=j.mediumBlank(1);ha.text=false;ha.image=fa[0].pin+'.png';}else ha=j.dot();return ha;},_getHighlightedSprite:function(){var ea=j.dot();ea.aggregationRadius=0;ea.css='fbTimelineMapHighlighted';return ea;},_highlightPlace:function(ea,fa){this._cleanUpHiglightedPin();var ga;if(ea&&this.places[ea]!==undefined){ga=this.places[ea].pin;ga.setSprite(this._getHighlightedSprite());this.map.redraw();}else{ga=new i();ga.anchor=m.fromLatLong(fa);ga.sprite=this._getHighlightedSprite();ga.isPreview=true;this.map.addPin(ga);}this.highlightedPin=ga;n.addClass(this.canvas,'fbTimelineMapDimPinMode');return ga;},_showCallout:function(ea,fa,ga){this._openCallout(ea,this.map.throbber(),this.smartPan);this._fetchCallout(ea,fa,ga);},_fetchCallout:function(ea,fa,ga){this.logger&&this.logger.startRun('load-callout');var ha=this._storeAsyncContext(ea),ia=this.places[fa],ja=[],ka={},la=ia.getStories();for(var ma=0;ma<la.length;++ma){var na=la[ma];if(!na.isEnt){ja.push(na.unitParams);}else{ka[na.storyType]=ka[na.storyType]||[];ka[na.storyType].push(na.id);}}var oa={profile_id:this.profileID,targetid:ia.id,storyid:ga,unitparams:ja,storiesbytype:ka,request_id:ha};if(this.viewasID&&this.viewasID!="0")oa.viewas=this.viewasID;new l().setURI('/ajax/timeline/map/callout.php').setMethod('POST').setData(oa).send();},_openCallout:function(ea,fa,ga){var ha=this.map.getCallout().getAnchor();ha&&this._dismissHovercard(ha);this.map.openCallout(ea,fa,ga);this._resizeCallout();},_zoomToPlace:function(ea){var fa=h.LEFT,ga=h.RIGHT,ha=this.map.getCallout().getOrientation()===fa,ia=new u(ha?200:-200,0);this.map.zoomIntoOne(ea.pin,ia);this._openCallout(ea.pin,this.map.throbber(),this.map.noPanningStrategy(ha?fa:ga));this._fetchCallout(ea.pin,ea.id);},_fetchHovercard:function(ea){this.logger&&this.logger.startRun('load-hovercard');if(ea.deleted||ea.hoverState!==this.HOVERCARD_WAITING_TO_FETCH)return;if(ea.pins.length<2)throw 'bubble has < 2 pins!';delete ea.timeoutToken;ea.hoverState=this.HOVERCARD_BEING_FETCHED;var fa=[],ga=[],ha={},ia={},ja={},ka={},la={},ma={};ea.pins.forEach(function(jb){var kb=jb.place,lb=kb.getStories();ma[kb.id]=true;for(var mb=0;mb<lb.length;mb++)fa.push(lb[mb]);ga.push(kb);if(kb.city){ha[kb.city]=ha[kb.city]||0;ha[kb.city]++;if(kb.region)la[kb.region]=kb.city;if(kb.country)ka[kb.country]=kb.city;}if(kb.region){ia[kb.region]=ia[kb.region]||0;ia[kb.region]++;}if(kb.country){ja[kb.country]=ja[kb.country]||0;ja[kb.country]++;}});var na=ga.length,oa=this._storeAsyncContext(ea),pa=this._getStoriesByType(fa).TimelineMapStoryPhoto||[],qa=pa.length,ra=z(pa).slice(0,4),sa={},ta=ga.length<=3,ua=ga.sort(function(jb,kb){return kb.getStories().length-jb.getStories().length;}).slice(0,3).map(function(jb){var kb=0,lb={},mb=jb.getStories();for(var nb=0;nb<mb.length;nb++){var ob=mb[nb],pb=ob.visitID;if(pb===0){kb++;}else if(!(pb in lb)){lb[pb]=true;kb++;}}sa[jb.id]=kb;return jb.id;}),va=false,wa=false,xa=false;for(var ya in this.places){var za=this.places[ya];if(!ma[za.id]&&(xa=xa||ja[za.country])&&(wa=wa||ia[za.region])&&(va=va||ha[za.city]))break;}var ab=null,bb=null,cb=null,db=null,eb=null,fb=function(jb,kb,lb){return jb[lb]-jb[kb];};ha=Object.keys(ha).sort(fb.curry(ha));ia=Object.keys(ia).sort(fb.curry(ia));ja=Object.keys(ja).sort(fb.curry(ja));var gb={};gb[this.TIMELINE_MAP_HOVERCARD_COUNTRY]=ja.map(function(jb){return ka[jb];});gb[this.TIMELINE_MAP_HOVERCARD_REGION]=ia.map(function(jb){return la[jb];});gb[this.TIMELINE_MAP_HOVERCARD_CITY]=ha;gb[this.TIMELINE_MAP_HOVERCARD_PLACE]=ga.map(function(jb){return jb.id;});if(ja.length>0)if(!xa){bb=this.TIMELINE_MAP_HOVERCARD_COUNTRY;if(ja.length>1){db=this.TIMELINE_MAP_HOVERCARD_COUNTRY;}else if(ia.length>1){db=this.TIMELINE_MAP_HOVERCARD_REGION;}else db=this.TIMELINE_MAP_HOVERCARD_CITY;}if(ia.length>0&&!bb){var hb=this.HOVERCARD_CITY_REGION_HEURISTIC;if(!wa||ia.length>1&&ha.length>ia.length*hb){bb=this.TIMELINE_MAP_HOVERCARD_REGION;if(ia.length>1){db=this.TIMELINE_MAP_HOVERCARD_REGION;}else db=this.TIMELINE_MAP_HOVERCARD_CITY;}}if(ha.length>0&&!bb)if(!va||ha.length>1){bb=this.TIMELINE_MAP_HOVERCARD_CITY;if(ha.length>1){db=this.TIMELINE_MAP_HOVERCARD_CITY;}else eb=ga.length;}if(!bb){bb=this.TIMELINE_MAP_HOVERCARD_PLACE;eb=-1;}ab=gb[bb];if(db)cb=gb[db];var ib={profile_id:this.profileID,request_id:oa,target_count:na,photo_count:qa,photo_ids:ra,place_counts:sa,target_ids:ua,all_places:ta,ids:ab,title_type:bb,subtitle_count:eb,links:cb,link_type:db};if(this.viewasID&&this.viewasID!="0")ib.viewas=this.viewasID;new l().setURI('/ajax/timeline/map/hovercard.php').setMethod('POST').setData(ib).send();},_dismissHovercard:function(ea){delete ea.timeoutToken;delete ea.hoverState;delete ea.hoverPermanent;if(this.map.getCallout().getAnchor()===ea)this.map.hideCallout();},_getStoriesByType:function(ea){var fa={};ea.forEach(function(ga){fa[ga.storyType]=fa[ga.storyType]||[];fa[ga.storyType].push(ga.isEnt?ga.id:ga.unitParams);});return fa;},_removeStories:function(ea,fa){var ga=0,ha=false,ia=this.places[ea],ja=[],ka;for(ka=0;ka<ia.stories.length;++ka){var la=ia.stories[ka];if(fa[la.id]){delete this.stories[la.id];++ga;}else ja.push(la);}if(ja.length===0){delete this.places[ea];ha=true;}else ia.stories=ja;return {place_removed:ha,stories_removed:ga};},_removeHiddenStories:function(){var ea=this.map.getCallout().getAnchor();if(!ea)return;if(ea.getType()!=='AggregatedMapPin')return;if(x(this.hiddenStories))return;var fa=ea.place.id,ga=this._removeStories(fa,this.hiddenStories);if(ga.stories_removed!==0){this._refresh();this.hiddenStories={};}},_guard:function(ea){return function(fa,ga){if(!ga||!ga._instanceid||ga._instanceid===this.instanceID)ea(fa,ga);}.bind(this);},_subscribe:function(ea,fa){this.arbiterListeners.push(k.subscribe(ea,this._guard(fa)));},_mapHandler_mapClick:function(){this._removeHiddenStories();this.map.hideCallout();this._inform(da.Events.mapClick);},_mapHandler_pinClick:function(ea,fa){this.logger&&this.logger.bumpTap('pin-click');this._removeHiddenStories();if(this.map.getCallout().getAnchor()===fa){this.map.hideCallout();}else this._showCallout(fa,fa.place.id);},_mapHandler_bubbleClick:function(ea,fa){this.logger&&this.logger.bumpTap('bubble-click');this.map.hideCallout();this.map.zoomInto(fa.pins);},_mapHandler_bubbleMouseover:function(ea,fa){if(!this.enableHovercards||fa.hoverPermanent)return;if(!fa.hoverState||fa.hoverState===this.HOVERCARD_CLOSED){fa.hoverState=this.HOVERCARD_WAITING_TO_FETCH;fa.timeoutToken=setTimeout(this._fetchHovercard.bind(this,fa),this.HOVER_FETCH_DELAY);}else if(fa.hoverState===this.HOVERCARD_WAITING_TO_DISMISS){clearTimeout(fa.timeoutToken);delete fa.timeoutToken;fa.hoverState=this.HOVERCARD_OPEN;}},_mapHandler_bubbleMouseout:function(ea,fa){if(fa.hoverPermanent)return;if(fa.hoverState===this.HOVERCARD_WAITING_TO_FETCH||fa.hoverState===this.HOVERCARD_BEING_FETCHED){clearTimeout(fa.timeoutToken);delete fa.timeoutToken;delete fa.hoverState;}else if(fa.hoverState===this.HOVERCARD_OPEN){fa.timeoutToken=setTimeout(this._dismissHovercard.bind(this,fa),this.HOVER_DISMISS_DELAY);fa.hoverState=this.HOVERCARD_WAITING_TO_DISMISS;}},_onBeforeLeave:function(){for(var ea=0;ea<this.arbiterListeners.length;ea++)this.arbiterListeners[ea].unsubscribe();for(var fa=0;fa<this.intervals.length;fa++)clearInterval(this.intervals[fa]);this.logger=null;this.map=null;this.places=null;}});w(da,{Events:{timeframeChange:'timeframeChange',mapClick:'mapClick'},Listeners:{addStories:'addStories',updateStory:'updateStory',deleteStory:'deleteStory',hideStory:'hideStory',undoHideStory:'undoHideStory',addPending:'addPending',page:'page',creationFlow:'creationFlow',cleanupCreationCallout:'cleanupCreationCallout',cancelCreation:'cancelCreation',creationFinished:'creationFinished',showCallout:'showCallout',callout:'callout',hovercard:'hovercard',highlightMapPlace:'highlightMapPlace',registerScrollableCallout:'registerScrollableCallout',setTimeframe:'setTimeframe',zoomToVisible:'zoomToVisible',hideCallout:'hideCallout',zoomIntoOne:'zoomIntoOne',zoomToArea:'zoomToArea'}});e.exports=da;});
__d("legacy:TimelineMapController",["TimelineMapController"],function(a,b,c,d){a.TimelineMapController=b('TimelineMapController');},3);
__d("TimelineMapFilter",["Arbiter","copyProperties","CSS","cx","DOM","ge","StickyPlaceholderInput","tidyEvent","$"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('CSS'),j=b('cx'),k=b('DOM'),l=b('ge'),m=b('StickyPlaceholderInput'),n=b('tidyEvent'),o=b('$');function p(){}h(p.prototype,{init:function(q,r,s,t,u,v,w){this._classes=w?{count:"_3d0",filter:"_3c_",selected:"_3s-",text:"_3sz"}:{count:'fbTimelineMapFilterTagCount',filter:'fbTimelineMapFilter',selected:'selected',text:'fbTimelineMapFilterText'};this.catNames=[];this.catIndex=0;this.mapController=q;this.container=o(r);this.stickies=s||[];this.filters=k.scry(this.container,'.'+this._classes.filter);this.tagUnit=l('fbTimelineMapTagUnit');this.tagUnitInited=false;this.mapID=t;this.pluralMap=u;this.initialCatName=v;var x={};for(var y=0;y<this.stickies.length;y++)for(var z=0;z<this.stickies[y].name.length;z++)x[this.stickies[y].name[z]]=this.stickies[y].countOnlyUnique;this.mapController.setCategoryCountUnique(x);n([g.subscribe('TimelineMap/timeframeChange',this.updateCategories.bind(this)),g.subscribe('TimelineAppSectionCuration/categoryHasContent',this.categoryHasContent.bind(this))]);},categoryHasContent:function(){return !this.stickies[this.catIndex].name.skip_to_want;},setCategory:function(q){this.mapController.setCategory(this.catNames[q]);var r=k.scry(this.container,'.'+this._classes.filter);i.removeClass(r[this.catIndex],this._classes.selected);this.catIndex=q;i.addClass(r[this.catIndex],this._classes.selected);var s=l('pagelet_timeline_medley_map')||o('pagelet_timeline_main_column'),t=k.scry(s,'.fbTimelineStickyHeaderPlaceComposer input.skiptowant')[0];if(t)t.setAttribute('value',this.stickies[q].name.skip_to_want);var u=k.scry(s,'.fbTimelineStickyHeaderPlaceComposer div.uiStickyPlaceholderInput')[0];if(u)m.setPlaceholderText(u,this.stickies[q].name.placeholder);var v=k.find(s,'div.'+"_4bn6");if(this.stickies[q].name.skip_to_want){g.inform('TimelineMapStickyHeaderComposer/hidePhotoTagUnit');i.addClass(v,"_522z");}else{g.inform('TimelineMapStickyHeaderComposer/showPhotoTagUnit');i.removeClass(v,"_522z");}var w=k.scry(s,'div.'+"_4_zv")[0];if(w)k.setContent(w,this.stickies[q].name.section_title);},setCategoryAndZoomToVisible:function(q){this.setCategory(q);this.mapController.zoomToVisible();},setFilter:function(q,r,s,t){if(typeof r==='string')return;var u=this.filters[q],v=s;if(v>=200)v=(v%100)+100;v=r[this.pluralMap[v]];this.catNames[q]=r[2];k.setContent(k.find(u,'.'+this._classes.text),v);k.setContent(k.find(u,'.'+this._classes.count),s);i.conditionClass(u.firstChild,t,!!t);i.show(u);},updateCategories:function(q,r){if(r._instanceid!==this.mapID)return;var s=this.mapController.getCategories(),t=this.catNames[this.catIndex]||this.initialCatName;this.catNames=[];var u=0;for(var v=0;v<this.stickies.length;v++){var w=this.stickies[v],x=w.name,y=0,z=w.domClass,aa=x[2];if(s[aa]){y=s[aa].count;delete s[aa];}if(w.showWhenZero||y!==0){this.setFilter(u,x,y,z);u++;}}var ba=[];for(var ca in s)ba.push(s[ca]);ba=ba.sort(function(ga,ha){return ha.count-ga.count;});for(var da=0;da<this.filters.length-u;da++){var ea=ba[da];if(ea){this.setFilter(da+u,ea.name,ea.count);}else i.hide(this.filters[da+u]);}if(t){this.initialCatName=null;var fa=this.catNames.indexOf(t);if(fa!=-1){this.setCategory(fa);}else this.setCategory(0);}}});e.exports=p;});
__d("TimelineMapFilterMedley",["CSS","DOM","Style","$","csx"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('DOM'),i=b('Style'),j=b('$'),k=b('csx');function l(m){var n=h.find(j('pagelet_timeline_medley_map'),"._3dc");g.show(m);h.setContent(n,m);i.set(n,'visibility','visible');}e.exports=l;});
__d("TimelineMapStickyHeaderComposer",["Arbiter","AsyncRequest","Bootloader","CSS","$","bind","copyProperties","ge"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncRequest'),i=b('Bootloader'),j=b('CSS'),k=b('$'),l=b('bind'),m=b('copyProperties'),n=b('ge');function o(){g.subscribe('TimelineMapStickyHeaderComposer/showPhotoTagUnit',this.showPhotoTagUnit.bind(this));g.subscribe('TimelineMapStickyHeaderComposer/hidePhotoTagUnit',this.hidePhotoTagUnit.bind(this));}m(o.prototype,{initPlaceTypeahead:function(p){p.subscribe('focus',function(){i.loadModules(['TimelineMLE'],function(q){q.hideFlyout();});g.inform('TimelineMapStickyHeaderComposer/typeaheadFocus');}.bind(this));p.subscribe('blur',function(){g.inform('TimelineMapStickyHeaderComposer/typeaheadBlur');}.bind(this));p.subscribe('select',function(){g.inform('TimelineMapStickyHeaderComposer/typeaheadSelect');}.bind(this));},showPhotoTagUnit:function(p,q){this.tagUnit=k('fbTimelineMapTagUnit');var r=g.inform('TimelineAppSectionCuration/categoryHasContent');j.conditionShow(this.tagUnit,r);var s=n('mainContainer');s&&j.addClass(s,'photoTaggingMode');if(!this.tagUnitInited){this.tagUnitInited=true;this.indicator=k('fbTimelineMapAddPhotoLoading');j.show(this.indicator);var t=q?q.sid:null;new h().setURI('/ajax/timeline/map/photo_strip.php').setData({div_id:'fbTimelineMapTagUnit',sid:t}).setReadOnly(true).setHandler(l(this,'_onLoadPhotoStrip')).send();}else this._onLoadPhotoStrip();},hidePhotoTagUnit:function(){this.tagUnit=k('fbTimelineMapTagUnit');j.hide(this.tagUnit);var p=n('mainContainer');p&&j.removeClass(p,'photoTaggingMode');},_onLoadPhotoStrip:function(){j.hide(this.indicator);}});e.exports=o;});
__d("legacy:TimelineMapStickyHeaderComposer",["TimelineMapStickyHeaderComposer"],function(a,b,c,d){a.TimelineMapStickyHeaderComposer=b('TimelineMapStickyHeaderComposer');},3);
__d("legacy:TimelineMapFilter",["TimelineMapFilter"],function(a,b,c,d){a.TimelineMapFilter=b('TimelineMapFilter');},3);
__d("TypeaheadTimelineHighlightMapPlace",["Arbiter","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties');function i(j){this._typeahead=j;}h(i.prototype,{_subscription:null,enable:function(){this._subscription=this._typeahead.subscribe(['reset','select','highlight'],function(j,k){if(j==='highlight'&&k.index!==-1&&k.selected.type!='freeform'&&k.selected.latitude&&k.selected.longitude&&!k.selected.changeCity&&k.index!=this.lastDataIdx){var l=k.selected.place_type=='city'?10:15;g.inform('TimelineMap/highlightMapPlace',{placeID:k.selected.uid,center:{latitude:k.selected.latitude,longitude:k.selected.longitude},zoom:l});}else if(j==='highlight'&&k.index==-1){g.inform('TimelineMap/highlightMapPlace',{dismiss:true});}else if(j==='select'){g.inform('TimelineMap/highlightMapPlace',{selected:true});}else if(j==='reset')g.inform('TimelineMap/highlightMapPlace',{dismiss:true});this.lastDataIdx=k&&k.index;});},disable:function(){this._typeahead.unsubscribe(this._subscription);this._subscription=null;}});e.exports=i;});
__d("TypeaheadTimelineShowThrobberOnSelect",["Arbiter","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties');function i(j){this._typeahead=j;}h(i.prototype,{_subscription:null,enable:function(){this._subscription=this._typeahead.subscribe(['select'],function(j,k){g.inform('TimelineMap/highlightMapPlace',{showThrobber:true});});},disable:function(){this._typeahead.unsubscribe(this._subscription);this._subscription=null;}});e.exports=i;});
__d("legacy:TimelineMapPlaceTypeaheadBehaviors",["TypeaheadTimelineHighlightMapPlace","TypeaheadTimelineShowThrobberOnSelect"],function(a,b,c,d){var e=b('TypeaheadTimelineHighlightMapPlace'),f=b('TypeaheadTimelineShowThrobberOnSelect');if(!a.TypeaheadBehaviors)a.TypeaheadBehaviors={};a.TypeaheadBehaviors.highlightMapPlace=function(g){g.enableBehavior(e);};a.TypeaheadBehaviors.showThrobberOnSelect=function(g){g.enableBehavior(f);};},3);
__d("TimelineMLEPhotoPreviewGrid",["AsyncUploadRequest","Bootloader","CSS","DOM","FileInputUploader","Parent","ProgressBar","SortableGroup","copyProperties","tx","TimelineMLEPhotoConfig"],function(a,b,c,d,e,f){var g=b('AsyncUploadRequest'),h=b('Bootloader'),i=b('CSS'),j=b('DOM'),k=b('FileInputUploader'),l=b('Parent'),m=b('ProgressBar'),n=b('SortableGroup'),o=b('copyProperties'),p=b('tx'),q=b('TimelineMLEPhotoConfig');function r(v,w,x){this._container=v;this._grid=w;this._photoLimit=x;this._progressBarMarkup=q.progressBarMarkup;this._loadingIndicators=[];if(!q.enableDrag)return;this._sortableGroup=new n().setGrabCallback(t).setDropCallback(u);var y=j.scry(w,'.mlePhotoPreviewThumb');for(var z=0;z<y.length;z++)this._bindPhoto(y[z]);}o(r.prototype,{destroy:function(){this._sortableGroup&&this._sortableGroup.destroy();},_getNumPhotos:function(){return j.scry(this._grid,'.mlePhotoPreviewThumb').length;},_bindPhoto:function(v){this._sortableGroup&&this._sortableGroup.addSortable(j.find(v,'input').getAttribute('value'),v);},_unbindPhoto:function(v){this._sortableGroup&&this._sortableGroup.removeSortable(j.find(v,'input').getAttribute('value'));},attachPhoto:function(v,w){if(!this._loadingIndicators[w])return;var x=this._loadingIndicators[w].getRoot();if(l.byTag(x,'body')){j.replace(x,v);this._bindPhoto(v);}delete this._loadingIndicators[w];},detachPhoto:function(v){this._unbindPhoto(v);j.remove(v);var w=this._getNumPhotos();if(w===0){i.show(j.find(this._container,'.mlePhotoButtons'));i.hide(j.find(this._container,'.mleAddMorePhotoButtons'));}else if(w===this._photoLimit-1)i.show(j.find(this._container,'.mleAddMorePhotoButtons'));},createPlaceholder:function(v){if(this._getNumPhotos()===this._photoLimit-1)i.hide(j.find(this._container,'.mleAddMorePhotoButtons'));var w=this._progressBarMarkup.cloneNode(true);w=j.appendContent(this._grid,w)[0];this._loadingIndicators[v]=new m(w);},destroyPlaceholder:function(v){if(!this._loadingIndicators[v])return;j.remove(this._loadingIndicators[v].getRoot());delete this._loadingIndicators[v];},initUploader:function(v,w){var x=v.getInput();x.multiple=w.multiple&&g.isSupported();v.subscribe('change',this._uploadPhotos.bind(this,x,w));},_uploadPhotos:function(v,w){i.hide(j.find(this._container,'.mlePhotoButtons'));i.show(j.find(this._container,'.mleAddMorePhotoButtons'));var x=v.files?v.files.length:1;if(x+this._getNumPhotos()>this._photoLimit){var y=p._("The maximum number of photos you can add to this life event is {limit}. Please remove some photos and try again.",{limit:this._photoLimit});h.loadModules(['Dialog'],function(ca){new ca().setTitle("Too Many Photos").setBody(y).setButtons(ca.OK).show();});s(v);return;}for(var z=0;z<x;z++){var aa=v.files?v.files[z].name:v.value.split('\\').pop();this.createPlaceholder(aa);}var ba=new k(v).setURI(w.uploadURI).setData(w.uploadData).setAllowCrossOrigin(true).setUploadInParallel(true);ba.subscribe('progress',this._onProgress.bind(this));ba.subscribe('failure',this._onFailure.bind(this));ba.send();s(v);},_onProgress:function(v,w){var event=w.event,x=this._loadingIndicators[w.upload.getFile().name];i.hide(j.find(x.getRoot(),'.mlePhotoLoadingIndicator'));i.show(j.find(x.getRoot(),'.mlePhotoProgressBar'));if(event.loaded==event.total){x.setPosition(50);x.setTarget(100,2000);}else x.setPosition(50*event.loaded/event.total);},_onFailure:function(v,w){this.destroyPlaceholder(w.upload.getFile().name);}});function s(v){v.value='';v.files=null;}function t(v){i.addClass(v,'dragging');}function u(v,w){i.removeClass(w,'dragging');}e.exports=r;});
__d("TimelineMLEPhotoPreview",["Event","CSS","Dialog","DOM","Layer","Parent","TimelineMLEPhotoPreviewGrid","$"],function(a,b,c,d,e,f){var g=b('Event'),h=b('CSS'),i=b('Dialog'),j=b('DOM'),k=b('Layer'),l=b('Parent'),m=b('TimelineMLEPhotoPreviewGrid'),n=b('$'),o=[],p={initPreviewGrid:function(q,r){var s=l.byClass(q,'mleContainer');p.destroyPreviewGrid(s);o[s.id]=new m(s,q,r);},destroyPreviewGrid:function(q){if(o[q.id]){o[q.id].destroy();delete o[q.id];}},initUploader:function(q,r,s){if(o[r])o[r].initUploader(q,s);},attachPhoto:function(q,r,s){if(o[q])o[q].attachPhoto(r,s);},listenForDetach:function(q,r){var s=o[r];g.listen(j.find(q,'.detachPhotoIcon'),'click',s.detachPhoto.bind(s,q));},listenForPhotoSelect:function(q,r,s){var t=n(r);g.listen(q,'click',function(){h.hide(j.find(t,'.mlePhotoButtons'));h.show(j.find(t,'.mleAddMorePhotoButtons'));i.getCurrent().hide();if(o[t.id])o[t.id].createPlaceholder(s);});},listenForSubmit:function(q,r,s){var t=n(s);q.subscribe('confirm',function(){var u=j.scry(q.getContentRoot(),'input[name="'+r+'"]'),v=[];for(var w=0;w<u.length;w++){var x=u[w];if(x.checked===true)v.push(x.value);}h.hide(j.find(t,'.mlePhotoButtons'));h.show(j.find(t,'.mleAddMorePhotoButtons'));var y;if(y=i.getCurrent())y.hide();if(y=k.getTopmostLayer())y.hide();if(o[t.id])for(w=0;w<v.length;w++)o[t.id].createPlaceholder(v[w]);});}};e.exports=p;});
__d("TimelineMLE",["Event","Arbiter","AsyncRequest","Bootloader","CSS","DOM","DOMScroll","Form","Parent","ProgressiveDatepicker","TimelineCapsule","TimelineComposerUtilities","TimelineContentLoader","TimelineMLEPhotoPreview","Vector","$","areObjectsEqual","csx","tidyEvent"],function(a,b,c,d,e,f){var g=b('Event'),h=b('Arbiter'),i=b('AsyncRequest'),j=b('Bootloader'),k=b('CSS'),l=b('DOM'),m=b('DOMScroll'),n=b('Form'),o=b('Parent'),p=b('ProgressiveDatepicker'),q=b('TimelineCapsule'),r=b('TimelineComposerUtilities'),s=b('TimelineContentLoader'),t=b('TimelineMLEPhotoPreview'),u=b('Vector'),v=b('$'),w=b('areObjectsEqual'),x=b('csx'),y=b('tidyEvent'),z=0,aa={},ba=null,ca=null;function da(la){return o.byClass(la,'mleFlyoutForm');}function ea(la){var ma=o.byClass(la.getContext(),'fbTimelineCapsule');if(ma)return ma;return s.capsuleForCurrentSection();}function fa(la){if(!la)return;var ma=u.getScrollPosition().x,na=u.getElementPosition(la).y;na=na-s.HEADER_SCROLL_CUTOFF;m.scrollTo(new u(ma,na,'document'));}function ga(la){var ma=n.serialize(la);if(!w(ma,aa.state)){ha(la);new i().setData(ma).setURI('/ajax/timeline/mle_header.php').setRelativeTo(la).send();}}function ha(la){la=la||aa.element;if(!la)return;aa={element:la,state:n.serialize(la)};}function ia(event){var la=event.getTarget(),ma=la.options[la.selectedIndex];h.inform('TimelineMLE/mleSelectUpdated',la);var na=o.byClass(ma,'mleFormContainer'),oa=l.scry(na,'.mleOtherLabel'),pa=l.scry(na,'.mleOtherField');if(oa.length)oa=oa[0];if(pa.length)pa=pa[0];if(k.hasClass(ma,'mleOther')){k.show(oa);k.show(pa);var qa=l.find(pa,'.inputOuter').firstChild;qa.focus();}else{k.hide(oa);k.hide(pa);}}function ja(la){if(la)g.listen(la,'change',ia);}var ka={cancel:function(la){if(da(la)){ka.hideFlyout();}else{var ma=o.byClass(la,'mleContainer');ma&&t.destroyPreviewGrid(ma);var na=o.byClass(la,'fbTimelineNewMLE'),oa=o.byClass(la,'fbTimelineCapsule');if(na){l.remove(na);}else{na=o.byClass(la,'fbTimelineEditMLE');k.removeClass(na,'fbTimelineEditMLE');l.remove(l.scry(na,'.timelineUnitContainer')[0]);k.show(l.scry(na,'.timelineUnitContainer')[0]);}if(k.hasClass(na,'fbTimelineNotStarred')){k.removeClass(na,'fbTimelineNotStarred');j.loadModules(['TimelineStar'],function(pa){pa.unstarUnit(na.childNodes[0],null,true);});}oa&&q.balanceCapsule(oa);}aa={};return false;},registerButtons:function(la,ma,na,oa){y(g.listen(ma,'mousedown',function(){la.standalone?ba.setStackable(false):l.setContent(l.find(oa,'.mleInlineErrorMsg'),'');}));if(na)y(g.listen(na,'click',function(pa){pa.prevent();if(la.location==='map')h.inform('TimelineMap/cancelCreation');la.standalone?ka.hideFlyout():ka.cancel(na);}));},replace:function(la,ma){var na=o.byClass(la,'mleContainer');na&&t.destroyPreviewGrid(na);if(da(la)){var oa=o.byClass(la,'fbTimelineEditMLEFlyout');if(oa){var pa=o.byClass(la,'uiContextualLayerPositioner'),qa=pa.getAttribute('data-ownerid');la=v(qa);ka.hideFlyout();}else{j.loadModules(['TimelineStoryPublisher'],function(ua){ua.publish(ma,ba.getContext());ka.hideFlyout();});return false;}}var ra=o.byClass(la,'fbTimelineNewMLE'),sa=o.byClass(la,'fbTimelineCapsule'),ta=false;if(ra){ta=true;k.removeClass(ra,'fbTimelineNewMLE');k.removeClass(ra,'mleEditUnitContainer');}else{ra=o.byClass(la,'fbTimelineEditMLE');k.removeClass(ra,'fbTimelineEditMLE');}l.setContent(ra,ma.streamStory);k.addClass(ra,'lifeEventContainer');if((ta||k.hasClass(ra,'fbTimelineNotStarred'))&&!l.scry(ra,'div.keepStarred')[0]){k.removeClass(ra,'fbTimelineNotStarred');j.loadModules(['TimelineStar'],function(ua){ua.unstarUnit(ra.childNodes[0],null,true);});}sa&&q.balanceCapsule(sa);return false;},swapInPromotedMLE:function(la,ma,na,oa){var pa=la.parentNode;l.replace(la,na);k.addClass(pa,'lifeEventContainer');k.removeClass(pa,'fbTimelineTwoColumn');k.addClass(pa,'fbTimelineOneColumn');ka.startEdit(pa,ma);l.insertAfter(l.scry(pa,'div.topBorder')[0],oa);return false;},startEdit:function(la,ma){ka.hideFlyout();var na=l.scry(la,'div.timelineUnitContainer')[0];k.hide(na);k.addClass(la,'fbTimelineEditMLE');if(!ma)k.addClass(la,'fbTimelineNotStarred');},showFlyout:function(la,ma,na){ka.hideFlyout();ba=la;z=0;h.subscribe('TimelineMLE/mleSelectUpdated',function(sa,ta){var ua=o.byClass(ta,'mleFormOuterContainer'),va=l.scry(ua,'.registrationLink');if(!va.length)return;var wa=ta.selectedIndex;k.hide(va[z]);k.show(va[wa]);z=wa;});if(ma==='header'||ma==='map'){j.loadModules(['TimelineStickyHeader'],function(sa){var ta=sa.getRoot();if(!ta)ta=v("pagelet_timeline_medley_map");var ua;if(ma==='header'){ua=l.scry(ta,'.lifeEventAttachment')[0]||l.scry(ta,"._yq")[0];}else ua=l.find(ta,'div.fbTimelineMapStickyHeaderComposerContainer');la.setContext(ua).show();var va=h.subscribe(sa.VISIBLE,function(wa,xa){if(!xa&&ba===la){ka.hideFlyout();va.unsubscribe();}});});}else if(ma==='composer'){r.showMLEFlyout(la);fa(la.getContext());}else if(ma==='yearly_summary'){la.setContext(v("addMLELink")).show();}else if(ma==='goals_pagelet'){la.setContext(v("addGoalLink")).show();}else if(ma==='edit'){la.show();var oa=v(na),pa=o.byClass(oa,'lifeEventContainer');k.addClass(pa,'fbTimelineEditMLE');var qa=l.find(la.getContent(),'.timelineUnitContainer');k.addClass(qa,'fbTimelineEditMLEFlyout');m.ensureVisible(qa,null,100);}else j.loadModules(['TimelineSpine'],function(sa){sa.showMLEFlyout(la);fa(la.getContext());});if(ma!='map'){var ra=l.scry(la.getContent(),'.mleSelect');if(ra.length)ja(ra[0]);}ka.setEstimatedDate(la);h.inform('TimelineMLE/mleFlyoutShown',la);},showPrivacyNotice:function(la,ma){if(!ma||!la)return;var na=l.find(la.getContent(),'.audienceSelector');ma.setContext(na).show();ca=ma;g.listen(na,'click',ma.hide.bind(ma));g.listen(l.find(ma.getContent(),'input'),'click',ma.hide.bind(ma));h.subscribe('TimelineMLE/mleFlyoutHidden',ma.hide.bind(ma));},hideFlyout:function(){if(ba){var la=ba,ma=l.scry(la.getContent(),'.mleContainer')[0];ma&&t.destroyPreviewGrid(ma);la.hide();aa={};ba=null;h.inform('TimelineMLE/mleFlyoutHidden');}},getFlyout:function(){return ba;},listenForEditChanges:function(la){var ma=l.find(la,'form.mleFormContainer'),na=ma.elements;for(var oa=0;oa<na.length;++oa){if(o.byClass(na[oa],'uiTypeahead')||o.byClass(na[oa],'uiTokenizer'))continue;g.listen(na[oa],'blur',function(){ga(ma);},g.Priority._BUBBLE);}aa={element:ma,state:n.serialize(ma)};},updateHeader:function(la){ga(o.byClass(la,'mleFormContainer'));},setEstimatedDate:function(la){var ma=p.getInstance(l.scry(la.getContent(),'.uiProgressiveDatepicker')[0]),na=l.scry(la.getContext().parentNode,'.fbTimelineComposerUnit')[0];if(!na)r.setEstimatedDate(ma,ea(la));},updatePrivacyNoticePosition:function(){ca&&ca.updatePosition();},registerOptionHandler:function(la){var ma=l.scry(la,'.lifeEventContainer')[0],na=l.scry(ma,'.mleSelect');if(na.length)ja(na[0]);},subscribeToTypeahead:function(la,ma){la.subscribe(['select','unselect','reset','blur'],ka.updateHeader.curry(ma));},subscribeToTokenizer:function(la,ma){la.subscribe(['addToken','removeToken'],ka.updateHeader.curry(ma));},replaceYearlySummary:function(la){l.replace(v('pagelet_yearly'),la);}};e.exports=a.TimelineMLE||ka;});
__d("legacy:TimelineMLE",["TimelineMLE"],function(a,b,c,d){a.TimelineMLE=b('TimelineMLE');},3);
__d("MapAppSectionCuration",["Arbiter","TimelineAppSectionCuration"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('TimelineAppSectionCuration'),i={registerContent:function(j){h.register(j,function(k,l,m){g.inform('TimelineMapStickyHeaderComposer/showPhotoTagUnit');m.unsubscribe();});}};e.exports=i;});
__d("TimelineMapTour",["Arbiter","AsyncRequest","Class","Tour","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncRequest'),i=b('Class'),j=b('Tour'),k=b('copyProperties');function l(m){this.parent.construct(this);m&&this.init(m);}i.extend(l,j);k(l.prototype,{ENDPOINT:'/ajax/timeline/map/tour.php',NEXT_STEPS:{start:'tag_photos',tag_photos:'tour_complete'},currentStep:null,_tokens:[],init:function(m){this.parent.init();this.currentStep=m;this._tokens=[g.subscribe('TimelineMapStickyHeaderComposer/typeaheadFocus',this._handleTypeaheadFocus.bind(this)),g.subscribe('TimelineMapStickyHeaderComposer/showPhotoTagUnit',this._handleAddPhotosClick.bind(this)),g.subscribe('TimelineMapTour/resumeTour',this.resumeTour.bind(this))];},_unsubscribeSubscriptions:function(){this.parent._unsubscribeSubscriptions();this._tokens.forEach(g.unsubscribe.bind(g));},showStep:function(m){this.parent.showStep(m);},resumeTour:function(){if(this.currentStep=='tag_photos')new h().setURI(this.ENDPOINT).send();},_handleTypeaheadFocus:function(){if(this.openDialog){this.hideOpenDialog();if(this.currentStep=='start')this._advanceTour();}},_handleAddPhotosClick:function(){if(this.openDialog){this.hideOpenDialog();if(this.currentStep=='tag_photos')this._advanceTour();}},_advanceTour:function(){if(this.NEXT_STEPS[this.currentStep])this._saveStep(this.NEXT_STEPS[this.currentStep]);},_completeTour:function(){if(this.currentStep!='tour_complete')this._saveStep('tour_complete');},_saveStep:function(m){this.currentStep=m;new h().setURI(this.ENDPOINT).setMethod('POST').setData({step:m,suppress:1}).send();}});e.exports=l;});